---
import GitHubActivity from './GitHubActivity.tsx';
import GitHubOrgActivity from './GitHubOrgActivity.tsx';
import DiscordActivity from './DiscordActivity.tsx';

interface Props {
  name: string;
  url: string;
  icon: string;
  feed?: 'github' | 'github-org' | 'discord';
  username?: string;
  org?: string;
  serverId?: string;
}

const { name, url, icon, feed, username, org, serverId } = Astro.props;

const brandColors: Record<string, { color: string; glow: string }> = {
  github: { color: '#ffffff', glow: 'rgba(255,255,255,0.15)' },
  twitter: { color: '#1da1f2', glow: 'rgba(29,161,242,0.15)' },
  linkedin: { color: '#0a66c2', glow: 'rgba(10,102,194,0.15)' },
  discord: { color: '#5865f2', glow: 'rgba(88,101,242,0.15)' },
  youtube: { color: '#ff0000', glow: 'rgba(255,0,0,0.15)' },
  tiktok: { color: '#00f2ea', glow: 'rgba(0,242,234,0.15)' },
  reddit: { color: '#ff4500', glow: 'rgba(255,69,0,0.15)' },
  substack: { color: '#ff6719', glow: 'rgba(255,103,25,0.15)' },
  email: { color: '#22d3ee', glow: 'rgba(34,211,238,0.15)' },
  portfolio: { color: '#22d3ee', glow: 'rgba(34,211,238,0.15)' },
  blog: { color: '#22d3ee', glow: 'rgba(34,211,238,0.15)' },
};

const { color, glow } = brandColors[icon] || brandColors.portfolio;

const icons: Record<string, string> = {
  github: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>`,
  twitter: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>`,
  linkedin: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>`,
  portfolio: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>`,
  blog: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`,
  substack: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M22.539 8.242H1.46V5.406h21.08v2.836zM1.46 10.812V24L12 18.11 22.54 24V10.812H1.46zM22.54 0H1.46v2.836h21.08V0z"/></svg>`,
  email: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`,
  discord: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>`,
  tiktok: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>`,
  reddit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>`,
  youtube: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>`,
};

const iconSvg = icons[icon] || icons.portfolio;

// User/Org type icons (small, inline)
const userIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
const orgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"></path><path d="M5 21V7l8-4v18"></path><path d="M19 21V11l-6-4"></path><path d="M9 9h1"></path><path d="M9 13h1"></path><path d="M9 17h1"></path></svg>`;

// Get the handle to display (no handle for Discord - server name shown in feed)
const handle = username || org;
const typeIcon = feed === 'github' ? userIcon : feed === 'github-org' ? orgIcon : null;
---

<div
  class="expandable-card group w-full bg-[#141414] border border-[#262626] rounded-lg transition-all duration-300 hover:scale-[1.02]"
  style={`--brand-color: ${color}; --brand-glow: ${glow};`}
  data-expanded="false"
  data-username={username}
  data-org={org}
  data-server-id={serverId}
>
  <!-- Header (always visible) -->
  <div class="card-header flex items-center w-full p-4">
    <a
      href={url}
      target="_blank"
      rel="noopener noreferrer"
      class="flex items-center gap-4 flex-1 min-w-0"
    >
      <span class="text-[#a1a1a1] group-hover:text-[var(--brand-color)] transition-colors flex-shrink-0" set:html={iconSvg} />
      <span class="flex items-center gap-2 min-w-0">
        <span class="text-[#fafafa] font-medium">{name}</span>
        {handle && (
          <span class="flex items-center gap-1 text-[#525252] text-sm truncate">
            <span>·</span>
            <span class="text-[#a1a1a1]" set:html={typeIcon} />
            <span class="truncate">@{handle}</span>
          </span>
        )}
      </span>
    </a>

    {feed && (
      <button
        class="expand-btn relative flex items-center gap-2 pl-3 border-l border-[#262626] text-[#a1a1a1] hover:text-[var(--brand-color)] transition-colors cursor-pointer"
        aria-expanded="false"
        aria-label="Toggle activity preview"
      >
        <!-- Recent activity notification dot with tooltip -->
        <div class="activity-dot-wrapper absolute -top-2 -right-2">
          <span
            class="activity-dot hidden min-w-[14px] h-[14px] px-0.5 text-[9px] font-bold bg-blue-500 text-white rounded-full items-center justify-center shadow-[0_0_6px_rgba(59,130,246,0.6)]"
            data-feed={feed}
          ></span>
          <span class="dot-tooltip">Loading...</span>
        </div>
        <svg
          class="chevron w-5 h-5 transition-transform duration-300"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
    )}
  </div>

  <!-- Peek preview (visible when collapsed, hidden when expanded) -->
  {feed === 'github' && username && (
    <div class="peek-preview overflow-hidden relative rounded-b-lg" style="height: 24px;">
      <div class="absolute inset-0 bg-gradient-to-b from-transparent to-[#141414] z-10 pointer-events-none"></div>
      <div class="px-4 opacity-65 blur-[1px] overflow-hidden">
        <div class="contrib-preview flex gap-[3px] flex-nowrap justify-end" data-username={username}>
          <!-- Placeholder squares while loading -->
          <div class="w-[8px] h-[8px] rounded-sm bg-[#161b22] flex-shrink-0"></div>
          <div class="w-[8px] h-[8px] rounded-sm bg-[#161b22] flex-shrink-0"></div>
          <div class="w-[8px] h-[8px] rounded-sm bg-[#161b22] flex-shrink-0"></div>
        </div>
      </div>
    </div>
  )}

  <!-- Expandable content with smooth animation -->
  {feed === 'github' && username && (
    <div class="activity-panel overflow-hidden max-h-0 opacity-0 transition-all duration-300 ease-out">
      <div class="px-4 pb-4 pt-2">
        <GitHubActivity client:idle username={username} profileUrl={url} />
      </div>
    </div>
  )}

  <!-- GitHub Org: Peek preview (visible when collapsed) -->
  {feed === 'github-org' && org && (
    <div class="peek-preview overflow-hidden relative rounded-b-lg" style="height: 24px;">
      <div class="absolute inset-0 bg-gradient-to-b from-transparent to-[#141414] z-10 pointer-events-none"></div>
      <div class="px-4 opacity-65 blur-[1px] overflow-hidden">
        <div class="org-repos-preview flex gap-3 flex-nowrap text-xs text-[#58a6ff]" data-org={org}>
          <span class="text-[#525252]">Loading repos...</span>
        </div>
      </div>
    </div>
  )}

  <!-- GitHub Org: Expandable content -->
  {feed === 'github-org' && org && (
    <div class="activity-panel overflow-hidden max-h-0 opacity-0 transition-all duration-300 ease-out">
      <div class="px-4 pb-4 pt-2">
        <GitHubOrgActivity client:idle org={org} profileUrl={url} />
      </div>
    </div>
  )}

  <!-- Discord: Peek preview (visible when collapsed) -->
  {feed === 'discord' && serverId && (
    <div class="peek-preview overflow-hidden relative rounded-b-lg" style="height: 24px;">
      <div class="absolute inset-0 bg-gradient-to-b from-transparent to-[#141414] z-10 pointer-events-none"></div>
      <div class="px-4 opacity-65 blur-[1px] overflow-hidden">
        <div class="discord-preview flex gap-2 items-center text-xs" data-server-id={serverId}>
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          <span class="text-[#a1a1a1]">Loading...</span>
        </div>
      </div>
    </div>
  )}

  <!-- Discord: Expandable content -->
  {feed === 'discord' && serverId && (
    <div class="activity-panel overflow-hidden max-h-0 opacity-0 transition-all duration-300 ease-out">
      <div class="px-4 pb-4 pt-2">
        <DiscordActivity client:idle serverId={serverId} inviteUrl={url} />
      </div>
    </div>
  )}
</div>

<style>
  .expandable-card {
    transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
  }

  .expandable-card:hover {
    border-color: var(--brand-color);
    box-shadow: 0 0 20px var(--brand-glow);
  }

  .expandable-card[data-expanded="true"] {
    border-color: var(--brand-color);
    box-shadow: 0 0 25px var(--brand-glow), 0 0 50px var(--brand-glow);
    animation: glow-pulse 2s ease-in-out infinite;
  }

  @keyframes glow-pulse {
    0%, 100% {
      box-shadow: 0 0 20px var(--brand-glow), 0 0 40px var(--brand-glow);
    }
    50% {
      box-shadow: 0 0 30px var(--brand-glow), 0 0 60px var(--brand-glow);
    }
  }

  .expandable-card[data-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  /* Peek preview transitions */
  .peek-preview {
    transition: height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
    margin-bottom: 0;
  }

  /* Hide peek preview when expanded */
  .expandable-card[data-expanded="true"] .peek-preview {
    height: 0 !important;
    opacity: 0;
    margin-bottom: 0;
    overflow: hidden;
  }

  /* Show activity panel when expanded */
  .expandable-card[data-expanded="true"] .activity-panel {
    max-height: 600px;
    opacity: 1;
  }

  /* Activity dot notification */
  .activity-dot:not(.hidden) {
    display: flex;
    animation: dot-pop-in 0.3s ease;
  }

  @keyframes dot-pop-in {
    from {
      opacity: 0;
      transform: scale(0);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Expand button bounce on click */
  .expand-btn {
    transition: transform 0.15s ease;
  }

  .expand-btn:active {
    transform: scale(0.85);
  }

  .expand-btn.bounce {
    animation: btn-bounce 0.4s ease;
  }

  @keyframes btn-bounce {
    0% { transform: scale(1); }
    30% { transform: scale(0.85); }
    50% { transform: scale(1.1); }
    70% { transform: scale(0.95); }
    100% { transform: scale(1); }
  }

  /* Activity dot tooltip */
  .activity-dot-wrapper {
    position: relative;
  }

  .dot-tooltip {
    position: absolute;
    bottom: 100%;
    right: 0;
    margin-bottom: 8px;
    padding: 4px 8px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 4px;
    font-size: 11px;
    color: #e5e5e5;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: none;
    z-index: 50;
  }

  .dot-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    right: 4px;
    border: 4px solid transparent;
    border-top-color: #333;
  }

  .activity-dot-wrapper:hover .dot-tooltip {
    opacity: 1;
    visibility: visible;
  }
</style>

<script>
  // Check if activity time represents recent activity (within 24h)
  function isRecentActivity(timeStr: string): boolean {
    if (!timeStr) return false;
    if (timeStr.endsWith('m')) return true; // minutes = definitely recent
    if (timeStr.endsWith('h')) {
      const hours = parseInt(timeStr);
      return hours <= 24;
    }
    return false;
  }

  // Count recent activities from events array
  function countRecentActivities(events: Array<{ time: string }>): number {
    if (!events || !Array.isArray(events)) return 0;
    return events.filter(e => isRecentActivity(e.time)).length;
  }

  // Update the activity dot and tooltip with count
  function updateActivityDot(card: Element, count: number) {
    const dot = card.querySelector('.activity-dot');
    const tooltip = card.querySelector('.dot-tooltip');

    if (dot) {
      if (count > 0) {
        dot.textContent = count > 9 ? '9+' : String(count);
        dot.classList.remove('hidden');
      } else {
        dot.classList.add('hidden');
      }
    }

    if (tooltip) {
      tooltip.textContent = count > 0
        ? `${count} activit${count === 1 ? 'y' : 'ies'} in last 24h`
        : 'No recent activity';
    }
  }

  // Initialize expandable cards
  document.querySelectorAll('.expandable-card').forEach((card) => {
    const btn = card.querySelector('.expand-btn');
    const username = card.getAttribute('data-username');
    const org = card.getAttribute('data-org');

    if (!btn) return;

    // Load recent activity count from localStorage cache (user)
    if (username) {
      try {
        const cached = localStorage.getItem(`github-activity-${username}`);
        if (cached) {
          const data = JSON.parse(cached);
          const recentCount = countRecentActivities(data.events);
          updateActivityDot(card, recentCount);
        }
      } catch {
        // Silent fail
      }
    }

    // Load recent activity count from localStorage cache (org)
    if (org) {
      try {
        const cached = localStorage.getItem(`github-org-activity-${org}`);
        if (cached) {
          const data = JSON.parse(cached);
          const recentCount = countRecentActivities(data.events);
          updateActivityDot(card, recentCount);
        }
      } catch {
        // Silent fail
      }
    }

    // Load Discord online count from localStorage cache
    const serverId = card.getAttribute('data-server-id');
    if (serverId) {
      try {
        const cached = localStorage.getItem(`discord-activity-${serverId}`);
        if (cached) {
          const data = JSON.parse(cached);
          // For Discord, show online count as the "activity" number
          if (data.stats?.onlineCount > 0) {
            updateActivityDot(card, data.stats.onlineCount);
          }
        }
      } catch {
        // Silent fail
      }
    }

    btn.addEventListener('click', () => {
      const isExpanded = card.getAttribute('data-expanded') === 'true';
      const willExpand = !isExpanded;
      card.setAttribute('data-expanded', String(willExpand));
      btn.setAttribute('aria-expanded', String(willExpand));

      // Track expansion with PostHog
      if (willExpand && typeof window !== 'undefined' && (window as any).posthog) {
        const serverId = card.getAttribute('data-server-id');
        const feedType = username ? 'github' : org ? 'github-org' : serverId ? 'discord' : 'unknown';
        const handle = username || org || serverId || 'unknown';
        (window as any).posthog.capture('activity_feed_expanded', {
          feed_type: feedType,
          handle: handle,
        });
      }

      // Trigger bounce animation
      btn.classList.remove('bounce');
      void (btn as HTMLElement).offsetWidth; // Force reflow
      btn.classList.add('bounce');
    });
  });

  // Update dot when user activity is fetched (custom event from React)
  document.addEventListener('github-activity-loaded', ((e: CustomEvent) => {
    const { username, recentCount } = e.detail;
    const card = document.querySelector(`[data-username="${username}"]`);
    if (card) {
      updateActivityDot(card, recentCount);
    }
  }) as EventListener);

  // Update dot when org activity is fetched (custom event from React)
  document.addEventListener('github-org-activity-loaded', ((e: CustomEvent) => {
    const { org, recentCount } = e.detail;
    const card = document.querySelector(`[data-org="${org}"]`);
    if (card) {
      updateActivityDot(card, recentCount);
    }
  }) as EventListener);

  // Update dot when Discord activity is fetched (custom event from React)
  document.addEventListener('discord-activity-loaded', ((e: CustomEvent) => {
    const { serverId, onlineCount } = e.detail;
    const card = document.querySelector(`[data-server-id="${serverId}"]`);
    if (card) {
      updateActivityDot(card, onlineCount);
      // Also update the preview
      updateDiscordPreview(serverId, onlineCount);
    }
  }) as EventListener);

  // Update Discord preview with online count
  function updateDiscordPreview(serverId: string, onlineCount: number) {
    const preview = document.querySelector(`.discord-preview[data-server-id="${serverId}"]`);
    if (!preview) return;
    preview.innerHTML = `
      <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
      <span class="text-green-400 font-medium">${onlineCount}</span>
      <span class="text-[#a1a1a1]">online</span>
    `;
  }

  // Load Discord preview from cache on init
  document.querySelectorAll('.discord-preview').forEach((preview) => {
    const serverId = preview.getAttribute('data-server-id');
    if (!serverId) return;

    // Try cache first
    try {
      const cached = localStorage.getItem(`discord-activity-${serverId}`);
      if (cached) {
        const data = JSON.parse(cached);
        if (data.stats?.onlineCount !== undefined) {
          updateDiscordPreview(serverId, data.stats.onlineCount);
          return;
        }
      }
    } catch {
      // Silent fail
    }

    // Fetch if no cache
    fetch(`/.netlify/functions/discord-activity?serverId=${serverId}`)
      .then(res => res.json())
      .then(data => {
        if (data.stats?.onlineCount !== undefined) {
          updateDiscordPreview(serverId, data.stats.onlineCount);
          // Save to cache
          try {
            data.fetchedAt = Date.now();
            localStorage.setItem(`discord-activity-${serverId}`, JSON.stringify(data));
          } catch {}
        }
      })
      .catch(() => {});
  });

  // Format star count (e.g., 1200 -> 1.2k)
  function formatStars(num: number): string {
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}m`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}k`;
    return num.toString();
  }

  // Update org repos preview with actual repo names and stars
  function updateOrgReposPreview(org: string, repos: Array<{ name: string; stars: number }>) {
    const preview = document.querySelector(`.org-repos-preview[data-org="${org}"]`);
    if (!preview || !repos || repos.length === 0) return;

    const html = repos.slice(0, 4).map(r =>
      `<span class="flex items-center gap-1">${r.name} <span class="text-yellow-400">★</span><span class="text-[#a1a1a1]">${formatStars(r.stars)}</span></span>`
    ).join('<span class="text-[#525252]">·</span>');
    preview.innerHTML = html;
  }

  // Load org repos from cache on init
  document.querySelectorAll('.org-repos-preview').forEach((preview) => {
    const org = preview.getAttribute('data-org');
    if (!org) return;

    // Try cache first
    try {
      const cached = localStorage.getItem(`github-org-activity-${org}`);
      if (cached) {
        const data = JSON.parse(cached);
        if (data.repos) {
          updateOrgReposPreview(org, data.repos);
          return;
        }
      }
    } catch {
      // Silent fail
    }

    // Fetch if no cache
    fetch(`/.netlify/functions/github-org-activity?org=${org}`)
      .then(res => res.json())
      .then(data => {
        if (data.repos) {
          updateOrgReposPreview(org, data.repos);
          // Save to cache
          try {
            data.fetchedAt = Date.now();
            localStorage.setItem(`github-org-activity-${org}`, JSON.stringify(data));
          } catch {}
        }
      })
      .catch(() => {});
  });

  // Contribution level colors
  const levelColors = [
    'bg-[#161b22]', // level 0
    'bg-[#0e4429]', // level 1
    'bg-[#006d32]', // level 2
    'bg-[#26a641]', // level 3
    'bg-[#39d353]', // level 4
  ];

  // Update contribution preview with real data
  function updateContribPreview(username: string, days: Array<{ level: number }>) {
    const preview = document.querySelector(`.contrib-preview[data-username="${username}"]`);
    if (!preview || !days || days.length === 0) return;

    // Get last 40 days for the preview
    const recentDays = days.slice(-40);
    const html = recentDays.map(day => {
      const colorClass = levelColors[day.level] || levelColors[0];
      return `<div class="w-[8px] h-[8px] rounded-sm ${colorClass} flex-shrink-0"></div>`;
    }).join('');
    preview.innerHTML = html;
  }

  // Load contribution data from cache on init
  document.querySelectorAll('.contrib-preview').forEach((preview) => {
    const username = preview.getAttribute('data-username');
    if (!username) return;

    // Try cache first
    try {
      const cached = localStorage.getItem(`github-activity-${username}`);
      if (cached) {
        const data = JSON.parse(cached);
        if (data.contributions?.days) {
          updateContribPreview(username, data.contributions.days);
          return;
        }
      }
    } catch {
      // Silent fail
    }

    // Fetch if no cache
    fetch(`/.netlify/functions/github-activity?username=${username}`)
      .then(res => res.json())
      .then(data => {
        if (data.contributions?.days) {
          updateContribPreview(username, data.contributions.days);
          // Save to cache
          try {
            data.fetchedAt = Date.now();
            localStorage.setItem(`github-activity-${username}`, JSON.stringify(data));
          } catch {}
        }
      })
      .catch(() => {});
  });
</script>
